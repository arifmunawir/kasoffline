<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aplikasi Kas — In/Out (Final + Pagination + Saldo)</title>
<style>
  :root{--primary:#007bff;--danger:#dc3545;--muted:#666}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f5f7fb;padding:18px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:980px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  header h1{font-size:1.15rem;margin:0}
  .card{background:#fff;border-radius:10px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(13,38,76,0.06)}
  .grid{display:grid;grid-template-columns:140px 1fr 140px;gap:10px;align-items:end}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"],input[type="date"],select{width:100%;padding:9px;border-radius:8px;border:1px solid #e6eef8;font-size:14px}
  .btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:14px}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid #d7e6ff}
  .btn.warn{background:#ffc107;color:#000}
  .btn.danger{background:var(--danger)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{width:100%;border-collapse:collapse;min-width:700px}
  th,td{padding:10px;border-bottom:1px solid #f0f3f8;text-align:left;font-size:14px}
  th{background:#fbfdff;cursor:pointer;user-select:none}
  th .sort-ind{margin-left:8px;font-size:12px;color:#888}
  .type-IN{color:green;font-weight:700}
  .type-OUT{color:var(--danger);font-weight:700}
  .link-btn{background:transparent;border:none;color:var(--primary);cursor:pointer;padding:4px 6px;border-radius:6px;font-size:13px}
  .link-btn.del{color:var(--danger)}
  .modal-back{position:fixed;inset:0;background:rgba(11,20,40,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{width:100%;max-width:520px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 12px 30px rgba(11,20,40,0.25)}
  .modal h3{margin:0 0 8px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .small{font-size:13px;color:#666}
  @media (max-width:880px){.grid{grid-template-columns:1fr}}
  @media (max-width:520px){th,td{padding:8px;font-size:13px}.modal{margin:12px}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Aplikasi Kas — In / Out</h1>
    <div class="small">Offline • Autosave (LocalStorage) • Backup: JSON / CSV</div>
  </header>

  <!-- INPUT -->
  <div class="card">
    <div class="grid">
      <div>
        <label for="inputDate">Tanggal</label>
        <input id="inputDate" type="date">
      </div>
      <div>
        <label for="inputType">Jenis</label>
        <select id="inputType">
          <option value="IN">IN (Masuk)</option>
          <option value="OUT">OUT (Keluar)</option>
        </select>
      </div>
      <div>
        <label for="inputAmount">Jumlah</label>
        <input id="inputAmount" type="number" min="0" placeholder="100000">
      </div>

      <div style="grid-column:1/ -1">
        <label for="inputNote">Catatan</label>
        <input id="inputNote" type="text" placeholder="Contoh: Penjualan / Belanja">
      </div>
    </div>

    <div class="row">
      <button class="btn" onclick="addTransaction()">Tambah Transaksi</button>
      <button class="btn ghost" onclick="confirmClearAll()">Bersihkan Semua</button>
      <button class="btn ghost" onclick="exportJSON()">Export JSON</button>
      <button class="btn" style="background:#28a745" onclick="exportCSV()">Export CSV</button>

      <input id="fileImport" type="file" accept="application/json" style="display:none" onchange="importJSON(event)">
      <button class="btn ghost" onclick="document.getElementById('fileImport').click()">Import JSON</button>
    </div>
  </div>

  <!-- FILTER / SEARCH / INFO -->
  <div class="card">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <div style="display:flex;gap:8px;align-items:center">
        <label class="small">Filter Tgl</label>
        <input id="filterFrom" type="date">
        <input id="filterTo" type="date">
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <label class="small">Jenis</label>
        <select id="filterType" onchange="applyPipeline()">
          <option value="ALL">ALL</option>
          <option value="IN">IN</option>
          <option value="OUT">OUT</option>
        </select>
      </div>

      <div style="flex:1;min-width:180px">
        <input id="searchQ" type="text" placeholder="Cari keterangan..." oninput="applyPipeline()">
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="small">Show</div>
        <select id="showLimit" onchange="changeLimit()">
          <option value="10">10</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="0">All</option>
        </select>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:10px;flex-wrap:wrap">
      <div>
        <div class="small">Saldo (Semua Data)</div>
        <div id="totalBalance" style="font-weight:700;font-size:18px">0</div>
      </div>
      <div>
        <div class="small">Saldo (Tampil / Filter)</div>
        <div id="viewBalance" style="font-weight:700;font-size:18px">0</div>
      </div>
      <div style="text-align:right">
        <div class="small" id="countInfo">0 transaksi</div>
        <div class="small" id="pageInfo">Page 0 / 0</div>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card table-wrap">
    <table>
      <thead>
        <tr>
          <th data-sort="date" onclick="toggleSort('date')">Tanggal <span class="sort-ind" id="sDate"></span></th>
          <th>Jenis</th>
          <th data-sort="amount" onclick="toggleSort('amount')">Jumlah <span class="sort-ind" id="sAmount"></span></th>
          <th>Catatan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap">
      <button class="btn ghost" onclick="prevPage()">Prev</button>
      <div id="pager" class="small">Page 1 / 1</div>
      <button class="btn ghost" onclick="nextPage()">Next</button>
    </div>
  </div>
</div>

<!-- Modal Edit -->
<div class="modal-back" id="modalRoot">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Edit Transaksi</h3>

    <div style="margin-top:8px">
      <label> Tanggal </label>
      <input id="editDate" type="date">
    </div>
    <div style="margin-top:8px">
      <label> Jenis </label>
      <select id="editType"><option>IN</option><option>OUT</option></select>
    </div>
    <div style="margin-top:8px">
      <label> Jumlah </label>
      <input id="editAmount" type="number" min="0">
    </div>
    <div style="margin-top:8px">
      <label> Catatan </label>
      <input id="editNote" type="text">
    </div>

    <div class="actions" style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" onclick="closeModal()">Batal</button>
      <button class="btn" id="saveEditBtn">Simpan</button>
    </div>
  </div>
</div>

<!-- Modal Clear All Confirm -->
<div class="modal-back" id="modalClear">
  <div class="modal">
    <h3>Hapus Semua Data?</h3>
    <p>Data akan dihapus permanen dari browser (LocalStorage). Yakin?</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" onclick="closeClear()">No</button>
      <button class="btn danger" onclick="confirmClearAllYes()">Yes, hapus semua</button>
    </div>
  </div>
</div>

<script>
/* -------------------------
   Data model & persistence
   ------------------------- */
const LS_KEY = 'kas_app_v1';
let transactions = []; // each: { id, date 'YYYY-MM-DD', type 'IN'|'OUT', amount(Number), note }
let filtered = [];
let currentPage = 1;
let showLimit = 10; // 0 == all
let sortField = 'date'; // 'date' or 'amount'
let sortDir = 'desc'; // 'asc' or 'desc'
let editingId = null;

/* --- helpers --- */
const $ = id => document.getElementById(id);
function todayDateString(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(transactions));
}
function load(){
  try {
    const s = localStorage.getItem(LS_KEY);
    transactions = s ? JSON.parse(s) : [];
  } catch(e){ transactions = []; }
}
function uid(){ return 'tx_' + Date.now() + '_' + Math.random().toString(36).slice(2,8); }
function fmtMoney(n){ return Number(n).toLocaleString('id-ID', {maximumFractionDigits:2}); }

/* --- initialize --- */
load();
// set default date input to today
$('inputDate').value = todayDateString();

/* wire inputs change to re-run pipeline */
['filterFrom','filterTo','filterType','searchQ'].forEach(id=>{
  $(id).addEventListener('input', ()=>{ currentPage=1; applyPipeline(); });
});
$('showLimit').addEventListener('change', ()=>{ showLimit = Number($('showLimit').value); currentPage=1; applyPipeline(); });

/* initial showLimit */
showLimit = Number($('showLimit').value);

/* -------------------------
   CRUD
   ------------------------- */
function addTransaction(){
  const date = $('inputDate').value || todayDateString();
  const type = $('inputType').value;
  const amount = Number($('inputAmount').value);
  const note = $('inputNote').value || '';

  if(!date || !isFinite(amount) || amount <= 0){ alert('Tanggal dan jumlah valid diperlukan'); return; }

  transactions.push({ id: uid(), date, type, amount: Number(amount), note });
  save();
  // clear inputs, keep date default to today
  $('inputAmount').value = '';
  $('inputNote').value = '';
  $('inputDate').value = todayDateString();
  applyPipeline();
}

/* Edit */
function openEditModal(id){
  const tx = transactions.find(t=>t.id===id);
  if(!tx) return alert('Data tidak ditemukan');
  editingId = id;
  $('editDate').value = tx.date;
  $('editType').value = tx.type;
  $('editAmount').value = tx.amount;
  $('editNote').value = tx.note;
  $('modalRoot').style.display = 'flex';
}
$('saveEditBtn').addEventListener('click', ()=>{
  if(!editingId) return closeModal();
  const tx = transactions.find(t=>t.id===editingId);
  if(!tx) return closeModal();
  const nd = $('editDate').value;
  const nt = $('editType').value;
  const na = Number($('editAmount').value);
  const nn = $('editNote').value;
  if(!nd || !isFinite(na) || na <= 0){ alert('Tanggal / jumlah valid'); return; }
  tx.date = nd; tx.type = nt; tx.amount = na; tx.note = nn;
  save();
  closeModal();
  applyPipeline();
});
function closeModal(){ editingId=null; $('modalRoot').style.display = 'none'; }

/* Delete */
function deleteTx(id){
  if(!confirm('Hapus transaksi ini?')) return;
  const idx = transactions.findIndex(t=>t.id===id);
  if(idx>=0) transactions.splice(idx,1);
  save();
  applyPipeline();
}

/* Clear All (confirm modal) */
function confirmClearAll(){ $('modalClear').style.display = 'flex'; }
function closeClear(){ $('modalClear').style.display = 'none'; }
function confirmClearAllYes(){
  localStorage.removeItem(LS_KEY);
  transactions = [];
  save();
  closeClear();
  // refresh page as requested
  location.reload();
}

/* -------------------------
   Filter / Sort / Pagination pipeline
   ------------------------- */
function applyPipeline(){
  // read filters
  const from = $('filterFrom').value || null;
  const to = $('filterTo').value || null;
  const type = $('filterType').value || 'ALL';
  const q = ($('searchQ').value || '').trim().toLowerCase();

  // filter
  filtered = transactions.filter(t=>{
    if(from && t.date < from) return false;
    if(to && t.date > to) return false;
    if(type !== 'ALL' && t.type !== type) return false;
    if(q && !(t.note || '').toLowerCase().includes(q)) return false;
    return true;
  });

  // compute balances
  const totalBal = transactions.reduce((s,t)=> s + (t.type==='IN' ? t.amount : -t.amount), 0);
  const viewBal  = filtered.reduce((s,t)=> s + (t.type==='IN' ? t.amount : -t.amount), 0);

  $('totalBalance').textContent = fmtMoney(totalBal);
  $('viewBalance').textContent  = fmtMoney(viewBal);
  $('countInfo').textContent = `${filtered.length} transaksi (total ${transactions.length})`;

  // sort
  if(sortField === 'date'){
    filtered.sort((a,b)=> {
      const va = new Date(a.date).getTime();
      const vb = new Date(b.date).getTime();
      return sortDir==='asc' ? va - vb : vb - va;
    });
  } else if(sortField === 'amount'){
    filtered.sort((a,b)=> sortDir==='asc' ? a.amount - b.amount : b.amount - a.amount);
  }

  // pagination
  renderTable();
}

/* Sorting toggles */
function toggleSort(field){
  if(sortField === field) sortDir = (sortDir==='asc' ? 'desc' : 'asc');
  else { sortField = field; sortDir = 'desc'; }
  // update indicators
  $('sDate').textContent = sortField==='date' ? (sortDir==='asc' ? '↑' : '↓') : '';
  $('sAmount').textContent = sortField==='amount' ? (sortDir==='asc' ? '↑' : '↓') : '';
  applyPipeline();
}

/* Pagination controls */
function changeLimit(){
  showLimit = Number($('showLimit').value);
  currentPage = 1;
  applyPipeline();
}
function nextPage(){
  const totalPages = (showLimit === 0) ? 1 : Math.max(1, Math.ceil(filtered.length / showLimit));
  if(currentPage < totalPages){ currentPage++; renderTable(); }
}
function prevPage(){
  if(currentPage > 1){ currentPage--; renderTable(); }
}

/* Render table with current page & limit */
function renderTable(){
  const tbody = $('tableBody');
  tbody.innerHTML = '';

  const limit = Number($('showLimit').value);
  const totalPages = (limit === 0) ? 1 : Math.max(1, Math.ceil(filtered.length / limit));
  if(currentPage > totalPages) currentPage = totalPages;
  if(currentPage < 1) currentPage = 1;

  const start = (limit === 0) ? 0 : (currentPage - 1) * limit;
  const end = (limit === 0) ? filtered.length : start + limit;
  const pageData = filtered.slice(start, end);

  pageData.forEach(tx=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${(new Date(tx.date)).toLocaleDateString()}</td>
      <td class="type-${tx.type}">${tx.type}</td>
      <td>${fmtMoney(tx.amount)}</td>
      <td>${(tx.note || '').replaceAll('<','&lt;').replaceAll('>','&gt;')}</td>
      <td>
        <button class="link-btn" onclick="openEditModal('${tx.id}')">Edit</button>
        <button class="link-btn del" onclick="deleteTx('${tx.id}')">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  $('pager').textContent = `Page ${currentPage} / ${totalPages}`;
  $('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
}

/* -------------------------
   Import / Export
   ------------------------- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(transactions, null,2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'kas-log.json'; a.click();
  URL.revokeObjectURL(url);
}
function importJSON(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try {
      const arr = JSON.parse(r.result);
      if(!Array.isArray(arr)) throw new Error('Format JSON tidak valid');
      // normalize entries
      transactions = arr.map(x => ({
        id: x.id || uid(),
        date: x.date || (x.tanggal || todayDateString()),
        type: (x.type==='OUT') ? 'OUT' : 'IN',
        amount: Number(x.amount || x.jumlah || 0),
        note: x.note || x.ket || x.note || ''
      }));
      save();
      currentPage = 1;
      applyPipeline();
      alert('Import berhasil');
    } catch(err){
      alert('Import gagal: ' + err.message);
    }
  };
  r.readAsText(f);
}
function exportCSV(){
  let lines = [ ['tanggal','jenis','jumlah','catatan'].join(',') ];
  transactions.forEach(t=>{
    const tanggal = `"${t.date}"`;
    const jenis = t.type;
    const jumlah = t.amount;
    const cat = `"${(t.note||'').replace(/"/g,'""')}"`;
    lines.push([tanggal,jenis,jumlah,cat].join(','));
  });
  const csv = lines.join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'kas-log.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* -------------------------
   Utility uid reused
   ------------------------- */
function uid(){ return 'tx_' + Date.now() + '_' + Math.random().toString(36).slice(2,8); }

/* -------------------------
   Init
   ------------------------- */
applyPipeline(); // initial render
</script>
</body>
</html>